---
title: "Recent Probes MLM Trait Relationships for Publication"
subtitle: "PD Inhibition Project"
author: "Nate Hall, Michael Hallquist"
date: "22 June 2020"
output:
  html_document:
    code_folding: show
    df_print: default
    mathjax: default
    number_sections: no
    theme: spacelab
    toc: yes
    toc_depth: 2
    toc_float: yes
    fig_width: 9 
    fig_height: 6 
  pdf_document:
    code_folding: hide
    df_print: default
    number_sections: no
    toc: yes
    toc_depth: 4
---
<style type="text/css">
body{ max-width: 2000px; margin: auto; padding: 1em; }
</style>

```{r setup, include=FALSE}
if (!require(pacman)) { install.packages("pacman"); library(pacman) }
p_load(car, nlme, lme4, readr, tidyverse, emmeans, cowplot, MplusAutomation, knitr, sas7bdat, ggcorrplot, psych, flextable)
knitr::opts_chunk$set(echo = TRUE) #print code by default
#knitr::opts_chunk$set(cache.path = "../../Outputs/flanker_mlms/")
options(digits=3)
options(width=180)

#preprocessed in flanker_mlm.Rmd
rp <- read.csv(file="../../../Data/preprocessed/recent_probes_full_sample_accCode.csv") %>% rename(correct = response, rt_log = rt_log_trim_grp, conflict = cond, cond = stim, id = subj_idx) 
rp <- rp %>% 
  mutate(correct = ifelse(is.na(rt_log), NA, correct),
         prev_rt=lag(rt) ,
         prev_rt = prev_rt - mean(prev_rt, na.rm=TRUE),
         prev_rt_z = as.vector(scale(prev_rt)),
         prev_error = ifelse(lag(correct) == 1, 0, 1))  #z-score rt to put parameter estimates on smaller scale
  
  

rp <- rp %>% mutate(cond = factor(ifelse(cond == "positive", "apositive", as.character(cond))))
# x$cond

#   rp[1,"prev_rt"] <- rp[2,"prev_rt"]
# rp[1,"prev_rt_z"] <- rp[2,"prev_rt_z"]
# rp[1,"prev_error"] <- 0



#basedir <- "C:/Users/timot/Documents/GitHub/PD_Inhibition_DDM"
# basedir <- "~/Data_Analysis/PD_Inhibition_DDM" 
basedir <- "~/github_repos/PD_Inhibition_DDM" 

mpq <- get(load(file.path(basedir, "Data/preprocessed/MPQ_all_scored_final.RData"))) %>% 
  filter(exclude_MPQ == 0) %>% select(subject, MPS_wbR:MPS_abR)
snap <- get(load(file.path(basedir, "Data/preprocessed/SNAP_all_scored_final.RData"))) %>% filter(exclude_SNAP == 0) %>% 
  select(subject, NEGTEMP:HDWK, DISINHP)
k10 <- sas7bdat::read.sas7bdat(file.path(basedir, "Data/SAS Originals/k10.sas7bdat")) %>%
  dplyr::select(subject, k10Total) %>% dplyr::rename(K10=k10Total)
stai <- sas7bdat::read.sas7bdat(file.path(basedir, "Data/SAS Originals/stai.sas7bdat")) %>%
  dplyr::select(subject, staitotal) %>% dplyr::rename(STAI=staitotal)

self_reps <- inner_join(mpq, snap, by = "subject")
self_reps <- left_join(self_reps, k10, by = "subject")
self_reps <- left_join(self_reps, stai, by = "subject")
# mpluscmd <- "/Users/mnh5174/Applications/Mplus/mplus"
mpluscmd <- "/Applications/Mplus/mplus"
```


# Initial model in Mplus (m5)

This model mimics m5 from flanker RT mlms for publication. 

```{r}
# <!-- m17 <- lmer(rt_inv ~ cond*block + trial_z + prev_rt_z + prev_error + -->
# <!--               (1 + trial_z + prev_rt_z + cond + prev_error | id) + -->
# <!--               (1 + trial_z + run_trial_z + prev_rt_z | id:block), -->
# <!--           na.action = na.exclude, control=lmerControl(optCtrl=list(maxfun=2e4)), #bump up iterations -->
# <!--           data = flanker, REML=FALSE) # control=lmerControl(optimizer = "nlminbwrap")) -->

m5_orig <- lmer(rt_log ~ cond  + trial_z + (1 + trial_z| id),
           na.action = na.exclude,
           data = rp, REML=FALSE)

jtools::summ(m5_orig)


#look for preliminary evidence of moderation
fscores_update <- read.csv("/Users/natehall/github_repos/PD_Inhibition_DDM/Code/factor_structure/AC_bsem_cfa_parcel_mod_savedata.csv") %>% select(SUBJECT, DISINHIB.Median, ANTAG.Median) %>% rename(id = SUBJECT, DISINH = DISINHIB.Median, ANTAG = ANTAG.Median) #%>% mutate(DISINH = -1*DISINH) #reverse code Constraint to set in maladaptive direction. 
cor(fscores_update) #make sure scores positively correlate

rp <- rp %>% left_join(fscores_update, by = "id")

m5 <- lmer(rt_log ~ cond*ANTAG  + trial_z*ANTAG + (1 + trial_z| id),
           na.action = na.exclude,
           data = rp, REML=FALSE)

jtools::summ(m5)


m5 <- lmer(rt_log ~ cond*DISINH  + trial_z*DISINH + (1 + trial_z| id),
           na.action = na.exclude,
           data = rp, REML=FALSE)

jtools::summ(m5)

m5 <- lmer(rt_log ~ cond*DISINH +cond*ANTAG  + trial_z*DISINH+ trial_z*ANTAG + (1 + trial_z| id),
           na.action = na.exclude,
           data = rp, REML=FALSE)

jtools::summ(m5)
```

```{r m17_mplus, cache=TRUE}

# rp <- rp %>% mutate(cond = ifelse(cond == "positive", 0,
#                             ifelse(cond == "negative_familiar", 1,
#                                    ifelse(cond == "negative_highly_familiar", 2,
#                                           ifelse(cond == "negative_rc", 3,4)))))
# head(rp)
m5_mplus <- mplusObject(
  TITLE = "Equivalent model to lmer m5 recent probes",
  DEFINE = "
  !cond = cond -1; ! 0 = negative_familiar, 1 = negative_highly_familiar, 2= negative_rc, 3 = negative_unfamiliar, 4 = positive 
  
  !positive = 0; 
  !IF (cond == 5) then positive = 1; 
  n_fam = 0; 
  IF (cond == 1) then n_fam = 1; 
  n_hfam = 0; 
  IF (cond == 2) then n_hfam = 1; 
  n_rc = 0; 
  IF (cond == 3) then n_rc = 1; 
  n_unfam = 0; 
  IF (cond == 4) then n_unfam = 1; 
  
  ",
  VARIABLE = "
    WITHIN = trial_z cond n_fam n_hfam n_rc n_unfam;
    USEVARIABLES = id rt_log trial_z cond n_fam n_hfam n_rc n_unfam;
    CLUSTER = id;
  ",
  ANALYSIS = "
    TYPE=TWOLEVEL RANDOM;
    ESTIMATOR=BAYES;
    BITERATIONS=(10000);
    CHAINS=2;
    PROCESSORS=4;
  ",
  MODEL = "
    %WITHIN%
    rt_log ON cond n_fam n_hfam n_rc n_unfam;
    trialslo | rt_log ON trial_z;    !random slope of trial
  
    %BETWEEN%
    !means of random slopes
  
    [trialslo];
  
    !variances of random slopes
    trialslo;
    
    ! 
    !rt_log ON trial_z
    
    !slope correlations
    !condslo runslo trialslo prevslo errslo WITH
    !   condslo runslo trialslo prevslo errslo;
    
    [rt_log]; !mean average RT
  ",
  PLOT = "TYPE = PLOT2;",
  OUTPUT = "TECH1 TECH8 STANDARDIZED CINTERVAL;",
  rdata = rp
)

mout <- mplusModeler(m5_mplus, dataout="rp_mplus.dat", 
                     modelout="rt_m5_rp.inp", run=TRUE, hashfilename = FALSE,
                     Mplus_command = mpluscmd)


# psych::dummy.code(rp$cond)
flextable(mout$results$parameters$stdyx.standardized %>% 
            filter(!paramHeader %in% c("Variances")) %>%
            select(-sig, -posterior_sd) %>%
            mutate(pval=2*pval, #convert to 2-tailed
                   pval=if_else(pval < .05, as.character(paste0(pval, "*")), as.character(pval))) 
) %>% autofit() #%>% save_as_docx(path = "~/Desktop/flanker_acc_traits.docx")
library(jtools)

summ(m5_orig)
summ(m5)
```


## Accuracy models

```{r}

m5_acc <- glmer(correct ~ cond + trial_z + prev_rt_z + (1 + trial_z|id),
          na.action = na.exclude, 
          data = rp, family=binomial,
          control=glmerControl(optCtrl=list(maxfun=2e4)))
```




